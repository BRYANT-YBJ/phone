<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>IELTS Speed</title>
    
    <style>
        :root {
            --bg: #000000;
            --blue: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --text: #FFFFFF;
            --text-dim: #8E8E93;
            --surface: rgba(28, 28, 30, 0.8);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", monospace;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            /* å…³é”®ï¼šç¦ç”¨è§¦æ‘¸å»¶è¿Ÿ */
            touch-action: manipulation; 
        }

        /* --- 1. é¡¶éƒ¨æ§åˆ¶æ  (Header) --- */
        .header {
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: 15px;
            padding-left: 20px;
            padding-right: 20px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-bottom: 0.5px solid #333;
        }

        .top-row {
            display: flex; justify-content: space-between; align-items: center;
        }

        .title-box {
            font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;
        }
        
        .audio-status-dot {
            width: 8px; height: 8px; background: #444; border-radius: 50%; transition: 0.2s;
        }
        .audio-status-dot.active { background: var(--green); box-shadow: 0 0 8px var(--green); }

        .mode-select {
            background: #1C1C1E; color: var(--blue); border: none;
            font-weight: 600; font-size: 0.9rem; padding: 6px 10px; border-radius: 8px;
        }

        .stats-row {
            display: flex; gap: 20px; font-size: 0.85rem; color: var(--text-dim);
        }
        .stat-highlight { color: var(--text); font-weight: 700; margin-left: 4px; font-variant-numeric: tabular-nums; }

        /* --- 2. å•è¯èˆå° (Fixed Top) --- */
        .stage {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* é ä¸Š */
            padding-top: 50px; 
            z-index: 10;
        }

        .meaning {
            color: var(--text-dim);
            font-size: 1.1rem;
            margin-bottom: 30px;
            min-height: 24px;
            opacity: 0; transition: opacity 0.2s;
        }
        .meaning.show { opacity: 1; }

        .word-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 6px;
            padding: 0 10px;
        }

        .char-box {
            width: 36px; height: 52px;
            border-bottom: 3px solid #3A3A3C;
            font-family: "SF Mono", monospace;
            font-size: 2.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            transition: transform 0.08s; /* æé€ŸåŠ¨ç”» */
        }

        /* çŠ¶æ€ç±» */
        .char-box.active { border-bottom-color: var(--blue); transform: translateY(-4px); }
        .char-box.correct { color: var(--text); border-bottom-color: transparent; }
        
        /* é”™è¯¯é—ªçƒ */
        .char-box.flash-red {
            color: var(--red) !important;
            border-bottom-color: var(--red);
            animation: quick-shake 0.2s;
        }

        /* é•¿æŒ‰å·çœ‹ */
        .word-grid.peek .char-box:not(.correct) { color: rgba(255,255,255,0.25); }

        .hint-text { margin-top: 40px; font-size: 0.8rem; color: #333; }

        /* --- 3. éšå½¢è¾“å…¥å±‚ (ä¼˜åŒ–ç‰ˆ) --- */
        .click-layer { position: absolute; inset: 0; z-index: 5; }
        
        #hidden-input {
            position: absolute; opacity: 0; top: 0; left: 0; height: 0; width: 0;
            /* å…³é”®ï¼šç§»é™¤æ‰€æœ‰è‡ªåŠ¨ä¿®æ­£ï¼Œå‡å°‘ç³»ç»Ÿå¹²æ‰° */
            pointer-events: none;
        }

        /* å¯åŠ¨é¡µ */
        .splash {
            position: fixed; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.3s;
        }
        .start-bubble {
            padding: 15px 40px; background: var(--blue); border-radius: 40px;
            font-weight: 700; font-size: 1.1rem; margin-top: 30px;
            box-shadow: 0 0 20px rgba(10, 132, 255, 0.4);
            animation: breathe 2s infinite;
        }

        @keyframes quick-shake { 0%,100% {transform:translateX(0)} 25% {transform:translateX(-4px)} 75% {transform:translateX(4px)} }
        @keyframes breathe { 50% { transform: scale(1.05); } }

    </style>
</head>
<body>

    <div class="header">
        <div class="top-row">
            <div class="title-box">
                IELTS Speed
                <div class="audio-status-dot" id="audio-dot"></div>
            </div>
            <select class="mode-select" id="mode-select" onchange="resetGame()">
                <option value="mix">ğŸ¯ Mix (P1+P4)</option>
                <option value="p1">ğŸ  P1 Survival</option>
                <option value="p4">ğŸ“ P4 Academic</option>
            </select>
        </div>
        <div class="stats-row">
            <span>Done <span class="stat-highlight" id="count">0</span></span>
            <span>WPM <span class="stat-highlight" id="wpm">0</span></span>
            <span>Left <span class="stat-highlight" id="left">0</span></span>
        </div>
    </div>

    <div class="stage">
        <div class="meaning" id="meaning">...</div>
        
        <div class="word-grid" id="word-grid" 
             ontouchstart="startPeek()" ontouchend="endPeek()">
        </div>

        <div class="hint-text">Hold to peek â€¢ Tap to type</div>
    </div>

    <div class="click-layer" onclick="focusInput()"></div>
    
    <input type="text" id="hidden-input" 
           autocomplete="off" 
           autocorrect="off" 
           autocapitalize="off" 
           spellcheck="false">

    <div class="splash" id="splash" onclick="initApp()">
        <h1 style="font-size: 2.5rem; letter-spacing: -1px;">IELTS</h1>
        <div style="color:#666">Low Latency Edition</div>
        <div class="start-bubble">Tap to Start</div>
    </div>

<script>
    // ==========================================
    // ğŸ¯ æ ¸å¿ƒæ•°æ® (P1 + P4)
    // ==========================================
    const DATA_P1 = "accommodation:ä½å®¿|deposit:æŠ¼é‡‘|landlord:æˆ¿ä¸œ|balcony:é˜³å°|garage:è½¦åº“|studio:å•é—´|suburb:éƒŠåŒº|cupboard:æ©±æŸœ|itinerary:è¡Œç¨‹|souvenir:çºªå¿µå“|museum:åšç‰©é¦†|hostel:æ—…ç¤¾|pharmacy:è¯æˆ¿|surgeon:å¤–ç§‘åŒ»ç”Ÿ|vaccine:ç–«è‹—|nutrition:è¥å…»|resume:ç®€å†|salary:è–ªæ°´|helmet:å¤´ç›”|luggage:è¡Œæ";
    const DATA_P4 = "environment:ç¯å¢ƒ|pollution:æ±¡æŸ“|erosion:ä¾µèš€|drought:å¹²æ—±|avalanche:é›ªå´©|volcano:ç«å±±|hurricane:é£“é£|atmosphere:å¤§æ°”|predator:æ•é£Ÿè€…|extinction:ç­ç»|species:ç‰©ç§|bacteria:ç»†èŒ|virus:ç—…æ¯’|agriculture:å†œä¸š|irrigation:çŒæº‰|archaeology:è€ƒå¤|psychology:å¿ƒç†|geography:åœ°ç†|biology:ç”Ÿç‰©|chemistry:åŒ–å­¦|architecture:å»ºç­‘|hypothesis:å‡è®¾|plagiarism:æŠ„è¢­|dissertation:è®ºæ–‡";

    // å¼•æ“
    let deck = [], remainingDeck = [];
    let currentWord = {};
    let charIndex = 0;
    
    // ç»Ÿè®¡
    let startTime = null;
    let totalInputs = 0, correctInputs = 0, correctWords = 0;
    
    // éŸ³é¢‘ä¸Šä¸‹æ–‡ (Web Audio API) - å…¨å±€ä¿æŒä¸€ä¸ªå®ä¾‹
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let actx = null;
    let realAudio = new Audio();

    // DOM
    const elInput = document.getElementById('hidden-input');
    const elGrid = document.getElementById('word-grid');
    const elMeaning = document.getElementById('meaning');
    const elDot = document.getElementById('audio-dot');
    const elSplash = document.getElementById('splash');

    // ğŸš€ åˆå§‹åŒ–
    function initApp() {
        // 1. åˆå§‹åŒ–éŸ³é¢‘å¼•æ“
        actx = new AudioContext();
        if(actx.state === 'suspended') actx.resume(); // è§£é” iOS éŸ³é¢‘

        // 2. éšè—å¯åŠ¨é¡µ
        elSplash.style.opacity = '0';
        setTimeout(() => elSplash.style.display = 'none', 300);

        // 3. ç»‘å®šè¶…é«˜é€Ÿè¾“å…¥ç›‘å¬
        // ä½¿ç”¨ 'input' äº‹ä»¶è€Œä¸æ˜¯ 'keydown'ï¼Œå…¼å®¹æ€§æ›´å¥½ï¼Œä½†è¦å¤„ç† buffer
        elInput.addEventListener('input', handleInputFast);
        
        // 4. iOS é”®ç›˜å›è½¦
        elInput.addEventListener('keydown', e => {
            if (e.key === 'Enter') { e.preventDefault(); playRealAudio(); }
        });

        // 5. ä¿æŒç„¦ç‚¹
        setInterval(() => {
            if(document.activeElement !== elInput && elSplash.style.display === 'none') {
                // å¯é€‰ï¼šè‡ªåŠ¨èšç„¦é€»è¾‘ï¼Œè§†ä½“éªŒè€Œå®š
                // elInput.focus(); 
            }
        }, 1000);

        resetGame();
        focusInput();
    }

    // --- ğŸ® æ¸¸æˆé€»è¾‘ ---
    function resetGame() {
        const mode = document.getElementById('mode-select').value;
        let p1 = parseData(DATA_P1);
        let p4 = parseData(DATA_P4);
        
        if (mode === 'p1') deck = p1;
        else if (mode === 'p4') deck = p4;
        else deck = [...p1, ...p4];

        remainingDeck = [...deck].sort(() => Math.random() - 0.5);
        correctWords = 0; totalInputs = 0; correctInputs = 0; startTime = null;
        updateStats();
        loadNextWord();
    }

    async function loadNextWord() {
        if(remainingDeck.length === 0) remainingDeck = [...deck].sort(() => Math.random() - 0.5);
        currentWord = remainingDeck.pop();
        charIndex = 0;

        // UI æ¸²æŸ“
        elMeaning.textContent = currentWord.m;
        elMeaning.classList.add('show');
        
        elGrid.innerHTML = '';
        currentWord.w.split('').forEach((char, i) => {
            const div = document.createElement('div');
            div.className = 'char-box';
            div.textContent = char;
            if(i===0) div.classList.add('active');
            elGrid.appendChild(div);
        });

        updateStats();
        
        // éŸ³é¢‘é¢„åŠ è½½
        elDot.classList.remove('active');
        await fetchAudio(currentWord.w);
        playRealAudio();
    }

    // --- âš¡ï¸ æé€Ÿè¾“å…¥å¤„ç† (å…³é”®ä¿®å¤) ---
    function handleInputFast(e) {
        // è·å–è¾“å…¥å­—ç¬¦
        let char = '';
        if (e.data) {
            char = e.data.slice(-1).toLowerCase(); // å–æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œé˜²æ­¢ buffer å †ç§¯
        } else if (e.inputType === 'insertText') {
            // æŸäº›å®‰å“æµè§ˆå™¨
            char = elInput.value.slice(-1).toLowerCase();
        } else {
            // åˆ é™¤æˆ–å…¶ä»–æ“ä½œ
            elInput.value = '';
            return;
        }

        // âš¡ï¸ å…³é”®ï¼šç«‹å³æ¸…ç©ºè¾“å…¥æ¡†ï¼Œé˜²æ­¢ iOS é¢„æµ‹æ–‡æœ¬é€ æˆâ€œåŒå‡»â€æ•ˆæœ
        // ä½¿ç”¨ setTimeout(0) ç¡®ä¿åœ¨æ¸²æŸ“å¸§ä¹‹åæ¸…ç†ï¼Œæˆ–è€…ç›´æ¥æ¸…ç†
        elInput.value = ''; 

        if (!char) return;
        if (!startTime) startTime = Date.now();
        totalInputs++;

        const target = currentWord.w[charIndex].toLowerCase();
        const slots = elGrid.children;
        const currentSlot = slots[charIndex];

        if (char === target) {
            // âœ… æ­£ç¡®ï¼šå…ˆåé¦ˆï¼Œå†é€»è¾‘
            playClickTone(); // 0å»¶è¿ŸéŸ³æ•ˆ
            triggerHaptic(); // éœ‡åŠ¨
            
            correctInputs++;
            currentSlot.classList.remove('active');
            currentSlot.classList.add('correct');
            charIndex++;

            if (charIndex >= currentWord.w.length) {
                correctWords++;
                playWinTone();
                setTimeout(loadNextWord, 150); // æé€Ÿåˆ‡æ¢
            } else {
                slots[charIndex].classList.add('active');
            }
        } else {
            // âŒ é”™è¯¯
            playErrorTone();
            triggerHaptic();
            
            // è§†è§‰åé¦ˆï¼šçº¢è‰²é—ªç°
            currentSlot.classList.add('flash-red');
            setTimeout(() => currentSlot.classList.remove('flash-red'), 250);
        }
        updateStats();
    }

    // --- ğŸ”Š é›¶å»¶è¿ŸåˆæˆéŸ³æ•ˆ (AudioContext Oscillator) ---
    // æ¯”åŠ è½½ MP3 å¿«å¾—å¤šï¼ŒæŒ‰ä¸‹çš„ç¬é—´å°±æœ‰å£°éŸ³
    function playClickTone() {
        if (!actx) return;
        const osc = actx.createOscillator();
        const gain = actx.createGain();
        
        osc.type = 'triangle'; // æ¸…è„†çš„â€œå“’â€å£°
        osc.frequency.setValueAtTime(600, actx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(100, actx.currentTime + 0.05);
        
        gain.gain.setValueAtTime(0.2, actx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + 0.05);
        
        osc.connect(gain); gain.connect(actx.destination);
        osc.start(); osc.stop(actx.currentTime + 0.05);
    }

    function playErrorTone() {
        if (!actx) return;
        const osc = actx.createOscillator();
        const gain = actx.createGain();
        
        osc.type = 'sawtooth'; // åˆºè€³çš„é”™è¯¯å£°
        osc.frequency.setValueAtTime(150, actx.currentTime);
        osc.frequency.linearRampToValueAtTime(100, actx.currentTime + 0.1);
        
        gain.gain.setValueAtTime(0.2, actx.currentTime);
        gain.gain.linearRampToValueAtTime(0, actx.currentTime + 0.1);
        
        osc.connect(gain); gain.connect(actx.destination);
        osc.start(); osc.stop(actx.currentTime + 0.1);
    }

    function playWinTone() {
        if (!actx) return;
        const osc = actx.createOscillator();
        const gain = actx.createGain();
        osc.frequency.setValueAtTime(400, actx.currentTime);
        osc.frequency.linearRampToValueAtTime(800, actx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.1, actx.currentTime);
        gain.gain.linearRampToValueAtTime(0, actx.currentTime + 0.1);
        osc.connect(gain); gain.connect(actx.destination);
        osc.start(); osc.stop(actx.currentTime + 0.1);
    }

    // --- ğŸ“³ è§¦æ„Ÿåé¦ˆ ---
    function triggerHaptic() {
        // Android æ”¯æŒï¼ŒiOS Safari æš‚ä¸æ”¯æŒ navigator.vibrate
        // ä½†å¦‚æœä»¥åå°è£…æˆ Appï¼Œè¿™è¡Œä»£ç å°±ä¼šç”Ÿæ•ˆ
        if (navigator.vibrate) navigator.vibrate(15);
    }

    // --- ğŸ§ çœŸäººè¯­éŸ³åŠ è½½ ---
    async function fetchAudio(word) {
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await res.json();
            const audioObj = data[0]?.phonetics.find(p => p.audio && p.audio.includes('-us.mp3')) 
                          || data[0]?.phonetics.find(p => p.audio);
            if(audioObj) {
                realAudio.src = audioObj.audio;
                realAudio.load();
                elDot.classList.add('active');
            }
        } catch(e) {}
    }
    
    function playRealAudio() {
        if (elDot.classList.contains('active')) {
            realAudio.currentTime = 0;
            realAudio.play().catch(()=>{});
        } else {
            // é™çº§ TTS
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(currentWord.w);
            u.lang = 'en-US'; u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }
    }

    // --- è¾…åŠ© ---
    function focusInput() { elInput.focus(); }
    function startPeek() { elGrid.classList.add('peek'); }
    function endPeek() { elGrid.classList.remove('peek'); }
    function parseData(str) { return str.split('|').map(s => { const [w, m] = s.split(':'); return { w, m }; }); }
    function updateStats() {
        document.getElementById('count').textContent = correctWords;
        document.getElementById('left').textContent = remainingDeck.length;
        if(startTime) {
            const m = (Date.now()-startTime)/60000;
            if(m>0) document.getElementById('wpm').textContent = Math.round((correctInputs/5)/m);
        }
    }
</script>
</body>
</html>