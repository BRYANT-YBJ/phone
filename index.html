<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>IELTS Ultimate</title>
    
    <style>
        :root {
            --bg: #000000;
            --blue: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --text: #FFFFFF;
            --text-dim: #8E8E93;
            --separator: #38383A;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            margin: 0;
            height: 100vh;
            /* å…³é”®ï¼šä½¿ç”¨ fixed å¸ƒå±€é˜²æ­¢é¡µé¢è¢«é”®ç›˜é¡¶ä¸Šå»ä¹±è·‘ */
            position: fixed; 
            width: 100%;
            overflow: hidden;
            user-select: none;
        }

        /* --- 1. é¡¶éƒ¨å›ºå®šåŒº (Header) --- */
        .header {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 120px; /* ç»™å•è¯ç•™å‡ºè¶³å¤Ÿçš„é¡¶éƒ¨ç©ºé—´ */
            padding-top: env(safe-area-inset-top);
            padding-left: 20px;
            padding-right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* å¯¹é½é¡¶éƒ¨ */
            z-index: 50;
            background: linear-gradient(to bottom, #000 80%, transparent); /* æ¸å˜é˜²é®æŒ¡ */
        }

        .streak-badge {
            margin-top: 10px;
            background: rgba(255, 159, 10, 0.2);
            color: #FF9F0A;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .audio-indicator {
            margin-top: 15px;
            width: 8px; height: 8px;
            background: #333;
            border-radius: 50%;
            transition: background 0.3s;
        }
        .audio-indicator.active { background: var(--green); box-shadow: 0 0 10px var(--green); }

        /* --- 2. å•è¯æ ¸å¿ƒæ˜¾ç¤ºåŒº (Top Anchor) --- */
        .stage-container {
            position: absolute;
            top: 15%; /* âš¡ï¸ æ ¸å¿ƒä¿®æ”¹ï¼šå›ºå®šåœ¨å±å¹•ä¸Šæ–¹ 15% å¤„ï¼Œé¿å¼€é”®ç›˜ */
            left: 0; right: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        /* é‡Šä¹‰ */
        .meaning-box {
            min-height: 24px;
            margin-bottom: 20px;
            color: var(--text-dim);
            font-size: 1.1rem;
            text-align: center;
            opacity: 0; transform: translateY(10px);
            transition: opacity 0.3s;
        }
        .meaning-box.visible { opacity: 1; transform: translateY(0); }

        /* å•è¯æ‹¼å†™æ§½ */
        .word-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
            padding: 0 10px;
        }

        .char-slot {
            width: 32px;
            height: 48px;
            border-bottom: 3px solid #3A3A3C;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: "SF Mono", monospace;
            font-size: 2rem;
            font-weight: 700;
            color: transparent;
            transition: all 0.1s;
        }

        /* çŠ¶æ€æ ·å¼ */
        .char-slot.active {
            border-bottom-color: var(--blue);
            transform: translateY(-4px); /* å½“å‰è¾“å…¥çš„å­—å¾®å¾®ä¸Šæµ® */
        }

        .char-slot.correct {
            color: var(--text);
            border-bottom-color: transparent;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        /* ğŸ”´ é”™è¯¯é—ªç°æç¤º */
        .char-slot.flash-error {
            color: var(--red) !important;
            border-bottom-color: var(--red);
            animation: shake 0.3s;
        }

        /* é•¿æŒ‰å·çœ‹ */
        .word-row.peeking .char-slot:not(.correct) {
            color: rgba(255,255,255,0.2);
        }

        /* --- 3. åº•éƒ¨ä¿¡æ¯æ  (Dock) --- */
        .dock {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            /* é¿å¼€é”®ç›˜ï¼šå½“é”®ç›˜å¼¹èµ·æ—¶ï¼Œè¿™ä¸ªdockå¯èƒ½ä¼šè¢«é¡¶ä¸Šæ¥æˆ–è€…ç›–ä½ï¼Œ
               ä½†åœ¨è¾“å…¥æ¨¡å¼ä¸‹æˆ‘ä»¬ä¸»è¦çœ‹ä¸Šé¢çš„å•è¯ï¼Œæ‰€ä»¥è¿™é‡Œæ”¾æ¬¡è¦ä¿¡æ¯ */
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            padding-top: 20px;
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 0.5px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            transition: transform 0.3s;
        }
        
        /* é”®ç›˜å¼¹èµ·æ—¶éšè—åº•éƒ¨æ ï¼Œç»™è§†é‡ç•™ç©ºé—´ (å¯é€‰ï¼Œè§†ä½“éªŒè€Œå®š) */
        body.keyboard-open .dock {
            transform: translateY(100%);
        }

        .stat-item { text-align: center; }
        .stat-num { font-size: 1.2rem; font-weight: 700; display: block; }
        .stat-lbl { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }

        /* éšå½¢è¾“å…¥æ¡† */
        #input-trap {
            position: absolute; opacity: 0; top: 0; left: 0;
            height: 0; width: 0;
            /* é˜²æ­¢ iOS æ”¾å¤§ */
            font-size: 16px; 
        }

        /* ç‚¹å‡»å…¨å±å”¤èµ·é”®ç›˜å±‚ */
        .trigger-layer {
            position: absolute; inset: 0; z-index: 5;
        }

        /* å¯åŠ¨é®ç½© */
        .splash {
            position: fixed; inset: 0; background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .tap-hint {
            margin-top: 30px; padding: 12px 30px;
            background: var(--blue); border-radius: 30px;
            font-weight: 600; animation: pulse 2s infinite;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes pulse { 50% { opacity: 0.6; } }

    </style>
</head>
<body>

    <div class="header">
        <div class="streak-badge">ğŸ”¥ <span id="streak">1</span></div>
        <div class="audio-indicator" id="audio-light"></div>
    </div>

    <div class="stage-container">
        <div class="meaning-box" id="meaning">...</div>
        
        <div class="word-row" id="word-row" 
             ontouchstart="startPeek()" ontouchend="endPeek()">
        </div>
        
        <div style="margin-top:30px; color:#3A3A3C; font-size:0.8rem">
            Hold to peek
        </div>
    </div>

    <div class="dock">
        <div class="stat-item">
            <span class="stat-num" id="done-count">0</span>
            <span class="stat-lbl">Done</span>
        </div>
        <div class="stat-item">
            <span class="stat-num" id="wpm">0</span>
            <span class="stat-lbl">WPM</span>
        </div>
        <div class="stat-item" onclick="switchMode()">
            <span class="stat-num" id="mode-lbl" style="color:var(--blue)">Mix</span>
            <span class="stat-lbl">Mode</span>
        </div>
    </div>

    <div class="trigger-layer" onclick="focusInput()"></div>
    <input type="text" id="input-trap" autocomplete="off" autocapitalize="off">

    <div class="splash" id="splash" onclick="initApp()">
        <h1 style="font-size:2.5rem; letter-spacing:-1px">IELTS Pro</h1>
        <div style="color:#555">Ultimate Edition</div>
        <div class="tap-hint">Tap to Start</div>
    </div>

<script>
    // ==========================================
    // ğŸ§ çœŸäººè¯­éŸ³è¯åº“ (Dictionary API æ˜ å°„)
    // ==========================================
    const DATA_SET = "schedule:æ—¶é—´è¡¨|laboratory:å®éªŒå®¤|advertisement:å¹¿å‘Š|garage:è½¦åº“|leisure:ä¼‘é—²|vitamin:ç»´ç”Ÿç´ |tomato:è¥¿çº¢æŸ¿|vase:èŠ±ç“¶|zebra:æ–‘é©¬|mobile:ç§»åŠ¨çš„|privacy:éšç§|route:è·¯çº¿|adult:æˆå¹´äºº|kilometre:å…¬é‡Œ|herb:è‰è¯|yogurt:é…¸å¥¶|missile:å¯¼å¼¹|innovation:åˆ›æ–°|entrepreneur:ä¼ä¸šå®¶|chaos:æ··ä¹±|queue:æ’é˜Ÿ|recipe:é£Ÿè°±|receipt:æ”¶æ®|salmon:ä¸‰æ–‡é±¼|sword:å‰‘";

    // çŠ¶æ€å˜é‡
    let deck = [], remainingDeck = [];
    let currentWord = {};
    let charIndex = 0;
    
    // ç»Ÿè®¡
    let startTime = null;
    let totalInputs = 0, correctInputs = 0, correctWords = 0;
    
    // Audio Context (ç”¨äºéŸ³æ•ˆ)
    let audioCtx = null;
    let realAudio = new Audio();
    
    // DOM
    const elInput = document.getElementById('input-trap');
    const elRow = document.getElementById('word-row');
    const elMeaning = document.getElementById('meaning');
    const elSplash = document.getElementById('splash');
    const elAudioLight = document.getElementById('audio-light');

    // ğŸš€ åˆå§‹åŒ–åº”ç”¨
    function initApp() {
        // 1. å”¤é†’ AudioContext (è§£å†³é™éŸ³é—®é¢˜)
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        // 2. éšè—å¯åŠ¨é¡µ
        elSplash.style.opacity = '0';
        setTimeout(() => elSplash.style.display = 'none', 500);
        
        // 3. å‡†å¤‡æ•°æ®
        loadDeck();
        
        // 4. èšç„¦é”®ç›˜
        focusInput();
        
        // 5. ç›‘å¬è¾“å…¥
        elInput.addEventListener('input', handleInput);
        
        // 6. ç›‘å¬é”®ç›˜å¼¹èµ· (è§†è§‰ä¼˜åŒ–)
        elInput.addEventListener('focus', () => document.body.classList.add('keyboard-open'));
        elInput.addEventListener('blur', () => document.body.classList.remove('keyboard-open'));
    }

    function loadDeck() {
        deck = DATA_SET.split('|').map(s => {
            const [w, m] = s.split(':');
            return { w, m };
        });
        deck.sort(() => Math.random() - 0.5);
        remainingDeck = [...deck];
        loadNextWord();
    }

    async function loadNextWord() {
        if (remainingDeck.length === 0) remainingDeck = [...deck].sort(() => Math.random() - 0.5);
        currentWord = remainingDeck.pop();
        charIndex = 0;

        // UI æ¸²æŸ“
        elMeaning.textContent = currentWord.m;
        elMeaning.classList.add('visible');
        
        elRow.innerHTML = '';
        currentWord.w.split('').forEach((char, i) => {
            const div = document.createElement('div');
            div.className = 'char-slot';
            div.textContent = char; // å®é™…ä¸Šæ–‡å­—åœ¨è¿™é‡Œï¼Œä½†é»˜è®¤é¢œè‰²é€æ˜
            if(i === 0) div.classList.add('active');
            elRow.appendChild(div);
        });

        // é¢„åŠ è½½éŸ³é¢‘
        preloadAudio(currentWord.w);
    }

    // --- ğŸ§ æ™ºèƒ½éŸ³é¢‘ç³»ç»Ÿ ---
    async function preloadAudio(word) {
        elAudioLight.classList.remove('active');
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await res.json();
            // ä¼˜å…ˆæ‰¾ç¾éŸ³ mp3
            const audioObj = data[0]?.phonetics.find(p => p.audio && p.audio.includes('-us.mp3')) 
                          || data[0]?.phonetics.find(p => p.audio);
            
            if (audioObj) {
                realAudio.src = audioObj.audio;
                realAudio.load();
                elAudioLight.classList.add('active'); // ç»¿ç¯äº®è¡¨ç¤ºå°±ç»ª
                playRealAudio(); // åŠ è½½å®Œç«‹å³æ’­æ”¾
            } else {
                fallbackTTS(word);
            }
        } catch (e) {
            fallbackTTS(word);
        }
    }

    function playRealAudio() {
        realAudio.currentTime = 0;
        realAudio.play().catch(() => fallbackTTS(currentWord.w));
    }

    function fallbackTTS(word) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(word);
        u.lang = 'en-US';
        u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    // --- âŒ¨ï¸ æ ¸å¿ƒè¾“å…¥é€»è¾‘ (å«é”™è¯¯é—ªç°) ---
    function handleInput(e) {
        if (!e.data) return;
        const inputChar = e.data.slice(-1).toLowerCase();
        elInput.value = ''; // æ¸…ç©ºï¼Œä¿æŒå¹²å‡€

        if (!startTime) startTime = Date.now();
        totalInputs++;

        const targetChar = currentWord.w[charIndex].toLowerCase();
        const slots = elRow.children;
        const currentSlot = slots[charIndex];

        if (inputChar === targetChar) {
            // âœ… æ­£ç¡®
            playClickSound(); // æœºæ¢°å£°
            correctInputs++;
            
            currentSlot.classList.remove('active');
            currentSlot.classList.add('correct');
            
            charIndex++;
            if (charIndex >= currentWord.w.length) {
                correctWords++;
                playSuccessSound();
                setTimeout(loadNextWord, 300);
            } else {
                slots[charIndex].classList.add('active');
            }
        } else {
            // âŒ é”™è¯¯ï¼šé—ªç°æ­£ç¡®ç­”æ¡ˆ
            playErrorSound();
            
            // 1. å¼ºåˆ¶æ˜¾ç¤ºå½“å‰æ ¼å­çš„æ­£ç¡®å­—æ¯ï¼ˆåˆ©ç”¨CSSé¢œè‰²å˜åŒ–ï¼‰
            currentSlot.classList.add('flash-error');
            
            // 2. éœ‡åŠ¨åé¦ˆ (å£°éŸ³æ¨¡æ‹Ÿ)
            
            // 3. 0.3ç§’åå¤åŸ
            setTimeout(() => {
                currentSlot.classList.remove('flash-error');
            }, 300);
        }
        updateStats();
    }

    // --- ğŸµ éŸ³æ•ˆåé¦ˆ (æ¨¡æ‹Ÿ Taptic Engine) ---
    function playClickSound() {
        // æ¸…è„†çš„æ‰“å­—éŸ³
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(600, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.03);
        g.gain.setValueAtTime(0.15, audioCtx.currentTime); // æé«˜ä¸€ç‚¹éŸ³é‡
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.03);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.03);
    }

    function playErrorSound() {
        // ä½æ²‰çš„é”™è¯¯éŸ³
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        g.gain.setValueAtTime(0.2, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    function playSuccessSound() {
        // æ‚¦è€³çš„å®ŒæˆéŸ³
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.frequency.setValueAtTime(440, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
    }

    // --- è¾…åŠ© ---
    function focusInput() { elInput.focus(); }
    function startPeek() { elRow.classList.add('peeking'); }
    function endPeek() { elRow.classList.remove('peeking'); }
    
    function updateStats() {
        document.getElementById('done-count').textContent = correctWords;
        if(startTime) {
            const m = (Date.now() - startTime)/60000;
            if(m>0) document.getElementById('wpm').textContent = Math.round((correctInputs/5)/m);
        }
    }
    
    function checkStreak() {
        const last = localStorage.getItem('ios_date');
        const today = new Date().toDateString();
        let s = parseInt(localStorage.getItem('ios_streak') || 1);
        if(last !== today) {
            s = (last === new Date(Date.now()-864e5).toDateString()) ? s+1 : 1;
            localStorage.setItem('ios_date', today);
            localStorage.setItem('ios_streak', s);
        }
        document.getElementById('streak').textContent = s;
    }

    window.onload = checkStreak;

</script>
</body>
</html>