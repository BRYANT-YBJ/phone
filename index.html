<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>IELTS P1+P4</title>
    
    <style>
        :root {
            --bg: #000000;
            --blue: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --text: #FFFFFF;
            --text-dim: #8E8E93;
            --surface: rgba(28, 28, 30, 0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            margin: 0;
            height: 100vh; /* Fallback */
            height: 100dvh; /* åŠ¨æ€é«˜åº¦ï¼Œé€‚åº”Safariåœ°å€æ å˜åŒ– */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- 1. é¡¶éƒ¨æ§åˆ¶ä¸­å¿ƒ (æ ¸å¿ƒæ“ä½œåŒº) --- */
        .header {
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: 10px;
            padding-left: 20px;
            padding-right: 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-bottom: 0.5px solid #333;
        }

        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .audio-dot {
            width: 8px; height: 8px; background: #333; border-radius: 50%;
            transition: 0.3s;
        }
        .audio-dot.ready { background: var(--green); box-shadow: 0 0 8px var(--green); }

        /* æ¨¡å¼é€‰æ‹©å™¨ (ç§»åˆ°é¡¶éƒ¨) */
        .mode-selector {
            background: #1C1C1E;
            border: none;
            color: var(--blue);
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
            outline: none;
            text-align: right;
        }

        /* æ•°æ®æ¦‚è§ˆ (ç§»åˆ°é¡¶éƒ¨) */
        .stats-bar {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }
        .stat-h { color: var(--text); font-weight: 600; margin-left: 4px; }

        /* --- 2. å•è¯èˆå° (å¼ºåˆ¶é ä¸Š) --- */
        .stage {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            /* âš¡ï¸ æ ¸å¿ƒï¼šè®©å†…å®¹é ä¸Šï¼Œç•™å‡ºä¸‹åŠéƒ¨åˆ†ç»™é”®ç›˜ */
            justify-content: flex-start; 
            padding-top: 40px; 
        }

        .meaning {
            color: var(--text-dim);
            font-size: 1.1rem;
            margin-bottom: 25px;
            height: 24px;
            opacity: 0; transition: opacity 0.3s;
        }
        .meaning.show { opacity: 1; }

        .word-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 4px;
            padding: 0 10px;
        }

        .slot {
            width: 34px; height: 50px;
            border-bottom: 3px solid #3A3A3C;
            font-family: "SF Mono", monospace;
            font-size: 2.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
            transition: transform 0.1s, border-color 0.2s;
        }

        .slot.active { border-bottom-color: var(--blue); transform: translateY(-4px); }
        .slot.correct { color: var(--text); border-bottom-color: transparent; }
        .slot.error { color: var(--red) !important; border-bottom-color: var(--red); }
        
        .word-row.peek .slot:not(.correct) { color: rgba(255,255,255,0.2); }

        .hint-text {
            margin-top: 30px;
            font-size: 0.8rem;
            color: #444;
        }

        /* --- 3. éšå½¢è¾“å…¥å±‚ --- */
        .input-trigger {
            position: absolute; inset: 0; z-index: 5;
        }
        #hidden-input {
            position: absolute; opacity: 0; top: 0; left: 0; height: 0; width: 0;
        }

        /* å¯åŠ¨é¡µ */
        .splash {
            position: fixed; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .start-btn {
            margin-top: 30px; padding: 12px 32px;
            background: var(--blue); color: white;
            border-radius: 30px; font-weight: 600;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="top-row">
            <div class="title">
                IELTS P1 & P4
                <div class="audio-dot" id="audio-dot"></div>
            </div>
            <select class="mode-selector" id="mode-select" onchange="resetGame()">
                <option value="mix">ğŸ¯ Mix (P1+P4)</option>
                <option value="p1">ğŸ  P1: Survival</option>
                <option value="p4">ğŸ“ P4: Academic</option>
            </select>
        </div>
        <div class="stats-bar">
            <span>Done <span class="stat-h" id="score">0</span></span>
            <span>WPM <span class="stat-h" id="wpm">0</span></span>
            <span>Left <span class="stat-h" id="left">0</span></span>
        </div>
    </div>

    <div class="stage">
        <div class="meaning" id="meaning">Fetching...</div>
        
        <div class="word-row" id="word-row"
             ontouchstart="startPeek()" ontouchend="endPeek()">
        </div>
        
        <div class="hint-text">Hold to peek</div>
    </div>

    <div class="input-trigger" onclick="focusInput()"></div>
    <input type="text" id="hidden-input" autocomplete="off" spellcheck="false">

    <div class="splash" id="splash" onclick="initApp()">
        <h1 style="font-size: 2rem;">IELTS Trainer</h1>
        <div style="color:#666; margin-top:10px">Part 1 & Part 4 Special</div>
        <div class="start-btn">Tap to Start</div>
    </div>

<script>
    // ==========================================
    // ğŸ¯ é›…æ€å¬åŠ›ä¸“é¡¹è¯åº“ (P1 & P4)
    // ==========================================
    // æ ¼å¼ï¼šword:meaning
    
    // Part 1: ç§Ÿæˆ¿ã€æ—…æ¸¸ã€æ—¥å¸¸ (ç”Ÿå­˜ç±»)
    const DATA_P1 = "accommodation:ä½å®¿|deposit:æŠ¼é‡‘|landlord:æˆ¿ä¸œ|balcony:é˜³å°|garage:è½¦åº“|corridor:èµ°å»Š|studio:å•é—´å…¬å¯“|suburb:éƒŠåŒº|cupboard:æ©±æŸœ|refrigerator:å†°ç®±|itinerary:è¡Œç¨‹è¡¨|reservation:é¢„è®¢|souvenir:çºªå¿µå“|museum:åšç‰©é¦†|hostel:æ—…ç¤¾|vegetarian:ç´ é£Ÿè€…|pharmacy:è¯æˆ¿|ambulance:æ•‘æŠ¤è½¦|surgeon:å¤–ç§‘åŒ»ç”Ÿ|vaccine:ç–«è‹—|nutrition:è¥å…»|interview:é¢è¯•|resume:ç®€å†|salary:è–ªæ°´|helmet:å¤´ç›”|luggage:è¡Œæ";

    // Part 4: ç¯å¢ƒã€ç”Ÿç‰©ã€ç§‘æŠ€ã€å­¦æœ¯ (é«˜éš¾ç±»)
    const DATA_P4 = "environment:ç¯å¢ƒ|pollution:æ±¡æŸ“|erosion:ä¾µèš€|drought:å¹²æ—±|avalanche:é›ªå´©|volcano:ç«å±±|hurricane:é£“é£|atmosphere:å¤§æ°”å±‚|renewable:å¯å†ç”Ÿçš„|predator:æ•é£Ÿè€…|migration:è¿å¾™|extinction:ç­ç»|species:ç‰©ç§|mammal:å“ºä¹³åŠ¨ç‰©|reptile:çˆ¬è¡ŒåŠ¨ç‰©|bacteria:ç»†èŒ|virus:ç—…æ¯’|photosynthesis:å…‰åˆä½œç”¨|agriculture:å†œä¸š|irrigation:çŒæº‰|archaeology:è€ƒå¤å­¦|civilization:æ–‡æ˜|psychology:å¿ƒç†å­¦|geography:åœ°ç†|biology:ç”Ÿç‰©|chemistry:åŒ–å­¦|architecture:å»ºç­‘|methodology:æ–¹æ³•è®º|hypothesis:å‡è®¾|plagiarism:æŠ„è¢­|dissertation:è®ºæ–‡|curriculum:è¯¾ç¨‹ä½“ç³»";

    // å¼•æ“å˜é‡
    let deck = [], remainingDeck = [];
    let currentWord = {};
    let charIndex = 0;
    let audioCtx, realAudio = new Audio();
    
    // ç»Ÿè®¡
    let startTime = null;
    let totalInputs = 0, correctInputs = 0, correctWords = 0;

    // DOM
    const elInput = document.getElementById('hidden-input');
    const elRow = document.getElementById('word-row');
    const elMeaning = document.getElementById('meaning');
    const elDot = document.getElementById('audio-dot');

    function initApp() {
        // å”¤é†’éŸ³é¢‘
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();

        document.getElementById('splash').style.opacity = 0;
        setTimeout(() => document.getElementById('splash').style.display = 'none', 500);

        // ç›‘å¬è¾“å…¥
        elInput.addEventListener('input', handleInput);
        elInput.addEventListener('keydown', e => {
            if(e.key==='Enter') { e.preventDefault(); playRealAudio(); }
        });

        resetGame();
        focusInput();
    }

    function resetGame() {
        const mode = document.getElementById('mode-select').value;
        let pool = [];
        
        if (mode === 'p1') pool = parseData(DATA_P1);
        else if (mode === 'p4') pool = parseData(DATA_P4);
        else pool = [...parseData(DATA_P1), ...parseData(DATA_P4)]; // Mix
        
        deck = pool;
        remainingDeck = [...deck].sort(() => Math.random() - 0.5);
        
        correctWords = 0; totalInputs = 0; correctInputs = 0; startTime = null;
        updateStats();
        loadNextWord();
    }

    async function loadNextWord() {
        if(remainingDeck.length === 0) remainingDeck = [...deck].sort(() => Math.random() - 0.5);
        currentWord = remainingDeck.pop();
        charIndex = 0;

        // UI
        elMeaning.textContent = currentWord.m;
        elMeaning.classList.add('show');
        elRow.innerHTML = '';
        currentWord.w.split('').forEach((char, i) => {
            const div = document.createElement('div');
            div.className = 'slot';
            div.textContent = char;
            if(i===0) div.classList.add('active');
            elRow.appendChild(div);
        });

        updateStats();
        // é¢„åŠ è½½
        elDot.classList.remove('ready');
        await fetchAudio(currentWord.w);
        playRealAudio();
    }

    // --- ğŸ§ æ™ºèƒ½éŸ³é¢‘ ---
    async function fetchAudio(word) {
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await res.json();
            const audioObj = data[0]?.phonetics.find(p => p.audio && p.audio.includes('-us.mp3')) 
                          || data[0]?.phonetics.find(p => p.audio);
            
            if(audioObj) {
                realAudio.src = audioObj.audio;
                realAudio.load();
                elDot.classList.add('ready');
            } else {
                throw new Error("No audio");
            }
        } catch(e) {
            // TTS Fallback
            elDot.classList.remove('ready');
        }
    }

    function playRealAudio() {
        if (elDot.classList.contains('ready')) {
            realAudio.currentTime = 0;
            realAudio.play().catch(()=>{});
        } else {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(currentWord.w);
            u.lang = 'en-US'; u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }
    }

    // --- âŒ¨ï¸ è¾“å…¥é€»è¾‘ ---
    function handleInput(e) {
        if(!e.data) return;
        const char = e.data.slice(-1).toLowerCase();
        elInput.value = '';

        if(!startTime) startTime = Date.now();
        totalInputs++;

        const target = currentWord.w[charIndex].toLowerCase();
        const slots = elRow.children;
        const slot = slots[charIndex];

        if(char === target) {
            // Correct
            playTick(600);
            correctInputs++;
            slot.classList.remove('active');
            slot.classList.add('correct');
            charIndex++;
            
            if(charIndex >= currentWord.w.length) {
                correctWords++;
                playSuccess();
                setTimeout(loadNextWord, 200);
            } else {
                slots[charIndex].classList.add('active');
            }
        } else {
            // Error
            playTick(150);
            slot.classList.add('error');
            setTimeout(() => slot.classList.remove('error'), 300);
        }
        updateStats();
    }

    // --- éŸ³æ•ˆ ---
    function playTick(freq) {
        if(audioCtx.state==='suspended') audioCtx.resume();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(freq, audioCtx.currentTime);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.05);
    }

    function playSuccess() {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(400, audioCtx.currentTime);
        o.frequency.linearRampToValueAtTime(800, audioCtx.currentTime + 0.1);
        g.gain.setValueAtTime(0.1, audioCtx.currentTime);
        g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(); o.stop(audioCtx.currentTime + 0.1);
    }

    // --- è¾…åŠ© ---
    function focusInput() { elInput.focus(); }
    function startPeek() { elRow.classList.add('peek'); }
    function endPeek() { elRow.classList.remove('peek'); }
    
    function parseData(str) {
        return str.split('|').map(s => {
            const [w, m] = s.split(':');
            return { w, m };
        });
    }

    function updateStats() {
        document.getElementById('score').textContent = correctWords;
        document.getElementById('left').textContent = remainingDeck.length;
        if(startTime) {
            const m = (Date.now() - startTime)/60000;
            if(m>0) document.getElementById('wpm').textContent = Math.round((correctInputs/5)/m);
        }
    }
</script>
</body>
</html>