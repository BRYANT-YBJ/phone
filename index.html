<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>IELTS Pro</title>
    
    <style>
        :root {
            /* iOS Design System Colors */
            --bg: #000000;
            --card-bg: #1c1c1e;
            --blue: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --separator: rgba(84, 84, 88, 0.65);
            /* æ¯›ç»ç’ƒæ•ˆæœ */
            --glass: rgba(30, 30, 30, 0.75);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
        }

        /* --- 1. é¡¶éƒ¨åŒºåŸŸ (é€‚é…çµåŠ¨å²›) --- */
        .header {
            /* å…³é”®ï¼šåˆ©ç”¨ padding-top é¿å¼€çµåŠ¨å²› */
            padding-top: max(20px, env(safe-area-inset-top)); 
            padding-bottom: 15px;
            padding-left: 24px;
            padding-right: 24px;
            background: var(--bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .streak-pill {
            background: rgba(255, 159, 10, 0.2);
            color: #FF9F0A;
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- 2. æ¸¸æˆæ ¸å¿ƒåŒº --- */
        .stage {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center; /* å‚ç›´å±…ä¸­ */
            align-items: center;
            position: relative;
            /* 120Hz åŠ¨ç”»ä¼˜åŒ–ï¼šä½¿ç”¨ GPU å±‚ */
            will-change: transform, opacity; 
        }

        /* ä¿¡æ¯æç¤º HUD */
        .hud {
            position: absolute;
            top: 15%;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); /* iOS ç‰©ç†æ›²çº¿ */
        }
        .hud.visible { opacity: 1; transform: translateY(0); }
        
        .phonetic { 
            color: var(--blue); 
            font-family: "SF Pro Rounded", system-ui;
            font-size: 1.4rem; 
            margin-bottom: 8px; 
            letter-spacing: 0.5px;
        }
        .meaning { color: var(--text-secondary); font-size: 1.1rem; }

        /* å•è¯å®¹å™¨ */
        .word-box {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            padding: 20px;
            transition: transform 0.1s;
        }
        
        /* äº¤äº’åé¦ˆï¼šæŒ‰ä¸‹æ—¶æ•´ä½“å¾®ç¼© */
        .word-box:active { transform: scale(0.97); }

        .char {
            font-family: "SF Mono", monospace;
            font-size: 3rem;
            font-weight: 600;
            width: 0.75em;
            text-align: center;
            color: transparent;
            border-bottom: 3px solid #3A3A3C;
            margin: 0 1px 16px 1px;
            transition: all 0.2s;
        }

        /* å·çœ‹æ¨¡å¼ */
        .word-box.peeking .char:not(.correct) {
            color: rgba(255,255,255,0.15);
            border-bottom-color: rgba(255,255,255,0.15);
        }

        .char.active {
            border-bottom-color: var(--blue);
            transform: translateY(-6px);
        }

        .char.correct {
            color: var(--text-primary);
            border-bottom-color: transparent;
            animation: bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .char.wrong {
            border-bottom-color: var(--red);
            animation: shake 0.3s;
        }

        /* --- 3. åº•éƒ¨æ‚¬æµ®å²› (é€‚é… Home Indicator) --- */
        .dock-container {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(28, 28, 30, 0.85);
            backdrop-filter: saturate(180%) blur(25px);
            -webkit-backdrop-filter: saturate(180%) blur(25px);
            border-top: 0.5px solid rgba(255,255,255,0.1);
            
            /* å…³é”®ï¼šé€‚é… iPhone 14 Pro åº•éƒ¨é»‘æ¡ */
            padding-bottom: env(safe-area-inset-bottom);
            padding-top: 16px;
            padding-left: 20px;
            padding-right: 20px;
            
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            z-index: 100;
        }

        .dock-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding-bottom: 10px;
        }

        /* æ•°æ®æ  */
        .stats-row {
            display: flex;
            justify-content: space-between;
            padding: 0 10px;
        }
        .stat-item { text-align: center; }
        .stat-val { font-size: 1.3rem; font-weight: 700; font-variant-numeric: tabular-nums; }
        .stat-lbl { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

        /* æŒ‰é’®ç»„ */
        .btn-row { display: flex; gap: 12px; }
        
        .ios-btn {
            flex: 1;
            height: 54px;
            background: rgba(255, 255, 255, 0.12);
            border: none;
            border-radius: 14px;
            color: var(--blue);
            font-size: 17px; /* iOS æ ‡å‡†æŒ‰é’®å­—å· */
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s, transform 0.1s;
        }
        
        .ios-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.96);
        }

        /* é”®ç›˜è¾“å…¥æ¡† (éšå½¢) */
        #hidden-input {
            position: absolute; opacity: 0; top: 0; left: 0; height: 0; width: 0;
        }
        
        /* éŸ³é¢‘åŠ è½½æŒ‡ç¤ºå™¨ */
        .audio-loader {
            width: 6px; height: 6px; background: var(--green); border-radius: 50%;
            position: absolute; top: 20px; right: 20px; opacity: 0; transition: opacity 0.3s;
        }
        .audio-loader.loading { background: var(--blue); opacity: 1; animation: blink 1s infinite; }
        .audio-loader.ready { background: var(--green); opacity: 0; }

        /* åŠ¨ç”» */
        @keyframes bounce { 0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }
        @keyframes blink { 50% { opacity: 0.5; } }

    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">IELTS Pro</div>
        <div class="streak-pill">
            ğŸ”¥ <span id="streak-val">1</span>
        </div>
        <div class="audio-loader" id="audio-status"></div>
    </div>

    <div class="stage" onclick="focusInput()">
        <div class="hud" id="hud">
            <div class="phonetic" id="phonetic">Loading...</div>
            <div class="meaning" id="meaning">...</div>
        </div>

        <div class="word-box" id="display"
             ontouchstart="startPeek()" ontouchend="endPeek()"
             onmousedown="startPeek()" onmouseup="endPeek()">
        </div>
        
        <div style="margin-top:20px; color:#545458; font-size:0.85rem">
            Hold to peek â€¢ Tap to type
        </div>
    </div>

    <div class="dock-container">
        <div class="dock-content">
            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-val" id="count">0</span>
                    <div class="stat-lbl">Done</div>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="wpm">0</span>
                    <div class="stat-lbl">WPM</div>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="deck-left">0</span>
                    <div class="stat-lbl">Left</div>
                </div>
            </div>
            
            <div class="btn-row">
                <button class="ios-btn" onclick="switchMode()">
                    <span id="mode-label">âš¡ Mix</span>
                </button>
                <button class="ios-btn" onclick="focusInput()">
                    âŒ¨ï¸ Keyboard
                </button>
            </div>
        </div>
    </div>

    <input type="text" id="hidden-input" autocomplete="off" spellcheck="false">

<script>
    // ==========================================
    // ğŸ§ çœŸäººè¯­éŸ³è¯åº“ (Dictionary API æ˜ å°„)
    // ==========================================
    // æˆ‘ä»¬åªå­˜å•è¯å’Œé‡Šä¹‰ï¼Œå‘éŸ³ç”± API å®æ—¶è·å–
    const DATA_MIX = "schedule:æ—¶é—´è¡¨|laboratory:å®éªŒå®¤|advertisement:å¹¿å‘Š|garage:è½¦åº“|leisure:ä¼‘é—²|vitamin:ç»´ç”Ÿç´ |tomato:è¥¿çº¢æŸ¿|vase:èŠ±ç“¶|zebra:æ–‘é©¬|mobile:ç§»åŠ¨çš„|privacy:éšç§|route:è·¯çº¿|adult:æˆå¹´äºº|kilometre:å…¬é‡Œ|herb:è‰è¯|yogurt:é…¸å¥¶|missile:å¯¼å¼¹|innovation:åˆ›æ–°|entrepreneur:ä¼ä¸šå®¶|chaos:æ··ä¹±|queue:æ’é˜Ÿ|recipe:é£Ÿè°±|receipt:æ”¶æ®|salmon:ä¸‰æ–‡é±¼|sword:å‰‘";

    // å¼•æ“å˜é‡
    let deck = [], remainingDeck = [];
    let currentWord = {};
    let charIndex = 0;
    let modeIndex = 0;
    const modes = ["âš¡ Mix", "ğŸ  Renting", "ğŸ“ Academic", "ğŸŒ¿ Nature"];
    
    // çœŸæ­£çš„éŸ³é¢‘å¯¹è±¡ (HTML5 Audio)
    let realAudio = new Audio();
    let isRealAudioAvailable = false;
    let fallbackSynth = window.speechSynthesis;

    // ç»Ÿè®¡
    let startTime = null;
    let totalInputs = 0, correctInputs = 0, correctWords = 0;

    // DOM
    const elInput = document.getElementById('hidden-input');
    const elDisplay = document.getElementById('display');
    const elStatus = document.getElementById('audio-status');

    function init() {
        checkStreak();
        // ç»‘å®šè¾“å…¥
        elInput.addEventListener('input', handleInput);
        // iOS é”®ç›˜å›è½¦å¤„ç†
        elInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); playAudio(); }
        });
        
        loadDeck();
    }

    function loadDeck() {
        // è§£ææ•°æ®
        deck = DATA_MIX.split('|').map(s => {
            const [w, m] = s.split(':');
            return { w, m };
        });
        deck.sort(() => Math.random() - 0.5);
        remainingDeck = [...deck];
        loadNextWord();
    }

    async function loadNextWord() {
        if (remainingDeck.length === 0) remainingDeck = [...deck].sort(() => Math.random() - 0.5);
        
        currentWord = remainingDeck.pop();
        charIndex = 0;

        // UI æ¸²æŸ“
        document.getElementById('meaning').textContent = currentWord.m;
        document.getElementById('hud').classList.add('visible');
        
        elDisplay.innerHTML = '';
        currentWord.w.split('').forEach((char, i) => {
            const span = document.createElement('span');
            span.textContent = char;
            span.className = 'char';
            if(i===0) span.classList.add('active');
            elDisplay.appendChild(span);
        });

        updateStats();

        // ğŸ”¥ å…³é”®ï¼šé¢„åŠ è½½çœŸäººå‘éŸ³
        await fetchRealAudio(currentWord.w);
        playAudio();
    }

    // --- ğŸ§ æ ¸å¿ƒï¼šè·å–çœŸäººå‘éŸ³ ---
    async function fetchRealAudio(word) {
        elStatus.className = 'audio-loader loading';
        document.getElementById('phonetic').textContent = "Loading...";
        isRealAudioAvailable = false;

        try {
            // è°ƒç”¨å…è´¹è¯å…¸ API
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await res.json();
            
            if (data && data[0]) {
                // 1. è·å–éŸ³æ ‡
                const phonetic = data[0].phonetic || (data[0].phonetics[1] ? data[0].phonetics[1].text : "/.../");
                document.getElementById('phonetic').textContent = phonetic;

                // 2. å¯»æ‰¾ç¾éŸ³æº (audio: ...-us.mp3)
                const audioObj = data[0].phonetics.find(p => p.audio && p.audio.includes('-us.mp3')) 
                              || data[0].phonetics.find(p => p.audio && p.audio.length > 0);
                
                if (audioObj) {
                    realAudio.src = audioObj.audio;
                    realAudio.load(); // é¢„åŠ è½½
                    isRealAudioAvailable = true;
                    elStatus.className = 'audio-loader ready';
                    return;
                }
            }
        } catch (e) {
            console.log("Audio fetch failed, fallback to TTS");
        }
        
        // å¤±è´¥å›è½
        elStatus.className = 'audio-loader'; // ç­ç¯
        document.getElementById('phonetic').textContent = `/${word}/`;
    }

    function playAudio() {
        if (isRealAudioAvailable) {
            realAudio.currentTime = 0;
            realAudio.play().catch(e => console.log("Playback prevented"));
        } else {
            // é™çº§æ–¹æ¡ˆï¼šTTS
            fallbackSynth.cancel();
            const u = new SpeechSynthesisUtterance(currentWord.w);
            u.lang = 'en-US';
            u.rate = 0.9;
            fallbackSynth.speak(u);
        }
    }

    // --- âŒ¨ï¸ äº¤äº’é€»è¾‘ ---
    function handleInput(e) {
        if (!e.data) return;
        const char = e.data.slice(-1).toLowerCase();
        elInput.value = '';

        if (!startTime) startTime = Date.now();
        totalInputs++;

        const target = currentWord.w[charIndex].toLowerCase();
        const spans = elDisplay.children;

        if (char === target) {
            // æ­£ç¡®ï¼šæ’­æ”¾æå…¶çŸ­ä¿ƒçš„â€œæ³¢â€å£°ï¼ˆiOS ç³»ç»Ÿ UI éŸ³æ•ˆæ¨¡æ‹Ÿï¼‰
            playSystemSound(600, 'sine'); 
            correctInputs++;
            spans[charIndex].classList.remove('active');
            spans[charIndex].classList.add('correct');
            charIndex++;

            if (charIndex >= currentWord.w.length) {
                correctWords++;
                playSuccessSound(); // å•è¯å®ŒæˆéŸ³æ•ˆ
                setTimeout(loadNextWord, 200);
            } else {
                spans[charIndex].classList.add('active');
            }
        } else {
            // é”™è¯¯
            playSystemSound(150, 'sawtooth');
            spans[charIndex].classList.add('wrong');
            setTimeout(() => spans[charIndex].classList.remove('wrong'), 300);
        }
        updateStats();
    }

    // --- ğŸµ iOS é£æ ¼éŸ³æ•ˆåˆæˆ (æ— éœ€åŠ è½½mp3) ---
    const actx = new (window.AudioContext || window.webkitAudioContext)();
    
    function playSystemSound(freq, type) {
        if(actx.state === 'suspended') actx.resume();
        const osc = actx.createOscillator();
        const g = actx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, actx.currentTime);
        
        // æçŸ­çš„è¡°å‡ï¼Œæ¨¡æ‹Ÿ Taptic Engine çš„æ¸…è„†æ„Ÿ
        g.gain.setValueAtTime(0.05, actx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, actx.currentTime + 0.05);
        
        osc.connect(g); g.connect(actx.destination);
        osc.start(); osc.stop(actx.currentTime + 0.05);
    }
    
    function playSuccessSound() {
        if(actx.state === 'suspended') actx.resume();
        const osc = actx.createOscillator();
        const g = actx.createGain();
        osc.frequency.setValueAtTime(400, actx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(800, actx.currentTime + 0.1); // ä¸Šå‡éŸ³è°ƒ
        g.gain.setValueAtTime(0.05, actx.currentTime);
        g.gain.linearRampToValueAtTime(0, actx.currentTime + 0.1);
        osc.connect(g); g.connect(actx.destination);
        osc.start(); osc.stop(actx.currentTime + 0.1);
    }

    // --- ğŸ“± è¾…åŠ©åŠŸèƒ½ ---
    function focusInput() { elInput.focus(); }
    function startPeek() { elDisplay.classList.add('peeking'); }
    function endPeek() { elDisplay.classList.remove('peeking'); }
    function switchMode() {
        modeIndex = (modeIndex + 1) % modes.length;
        document.getElementById('mode-label').textContent = modes[modeIndex];
    }

    function updateStats() {
        document.getElementById('deck-left').textContent = remainingDeck.length;
        document.getElementById('count').textContent = correctWords;
        if (startTime) {
            const mins = (Date.now() - startTime) / 60000;
            if (mins > 0) {
                const wpm = Math.round((correctInputs / 5) / mins);
                document.getElementById('wpm').textContent = wpm;
            }
        }
    }

    function checkStreak() {
        const last = localStorage.getItem('ios_date');
        const today = new Date().toDateString();
        let s = parseInt(localStorage.getItem('ios_streak') || 1);
        if(last !== today) {
            const y = new Date(); y.setDate(y.getDate()-1);
            s = (last === y.toDateString()) ? s+1 : 1;
            localStorage.setItem('ios_date', today);
            localStorage.setItem('ios_streak', s);
        }
        document.getElementById('streak-val').textContent = s;
    }

    window.onload = init;
</script>
</body>
</html>