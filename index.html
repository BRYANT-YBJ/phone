<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>IELTS Ultimate</title>
    
    <style>
        :root {
            --bg: #000000;
            --surface: rgba(28, 28, 30, 0.85);
            --blue: #0A84FF;
            --green: #30D158;
            --red: #FF453A;
            --text: #FFFFFF;
            --text-sec: #8E8E93;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", monospace;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            user-select: none;
            touch-action: manipulation;
        }

        /* --- 1. é¡¶éƒ¨çŠ¶æ€æ  (Top-Heavy Layout) --- */
        /* æŠŠæ‰€æœ‰é‡è¦ä¿¡æ¯éƒ½æ”¾åœ¨é¡¶éƒ¨ï¼Œç»å¯¹ä¸ä¼šè¢«é”®ç›˜æŒ¡ä½ */
        .header {
            padding-top: max(15px, env(safe-area-inset-top));
            padding-bottom: 15px;
            padding-left: 20px;
            padding-right: 20px;
            background: var(--surface);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid #333;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜ + æ—¶é—´ + éŸ³é¢‘ç¯ */
        .top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-group {
            display: flex; align-items: center; gap: 8px;
            font-weight: 800; font-size: 1.1rem;
        }

        .audio-dot {
            width: 8px; height: 8px; background: #444; border-radius: 50%;
            transition: 0.3s;
        }
        .audio-dot.ready { background: var(--green); box-shadow: 0 0 8px var(--green); }

        .clock {
            font-variant-numeric: tabular-nums;
            font-size: 0.9rem; color: var(--text-sec); font-weight: 500;
        }

        /* ç¬¬äºŒè¡Œï¼šæ¨¡å¼ + ç»Ÿè®¡ */
        .ctrl-row {
            display: flex; justify-content: space-between; align-items: center;
        }

        .mode-select {
            background: rgba(118, 118, 128, 0.24);
            color: var(--blue); border: none;
            font-size: 0.85rem; font-weight: 600;
            padding: 4px 10px; border-radius: 8px;
            outline: none;
        }

        .stats {
            display: flex; gap: 15px; font-size: 0.8rem; color: var(--text-sec);
        }
        .stat-val { color: var(--text); font-weight: 700; margin-left: 3px; }

        /* --- 2. ä¸»èˆå° (é ä¸Šå¸ƒå±€) --- */
        .stage {
            flex: 1;
            position: relative;
            display: flex; flex-direction: column;
            align-items: center;
            /* å…³é”®ï¼šé ä¸Šæ’åˆ—ï¼Œé¿å¼€é”®ç›˜åŒºåŸŸ */
            justify-content: flex-start; 
            padding-top: 40px; 
            z-index: 10;
        }

        .meaning {
            color: var(--text-sec);
            font-size: 1.1rem; margin-bottom: 25px;
            min-height: 24px; text-align: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .meaning.visible { opacity: 1; }

        /* å•è¯æ‹¼å†™åŒº */
        .word-grid {
            display: flex; flex-wrap: wrap; justify-content: center;
            gap: 5px; padding: 0 10px;
            /* æé«˜å±‚çº§ï¼Œç¡®ä¿é•¿æŒ‰èƒ½è§¦å‘è§¦æ‘¸äº‹ä»¶ï¼Œè€Œä¸æ˜¯è§¦å‘èƒŒæ™¯ç‚¹å‡» */
            z-index: 20; 
            touch-action: none; /* é˜²æ­¢é•¿æŒ‰å¼¹å‡ºèœå• */
        }

        .char-slot {
            width: 34px; height: 50px;
            border-bottom: 3px solid #3A3A3C;
            font-family: "SF Mono", monospace;
            font-size: 2.2rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            color: transparent; /* é»˜è®¤éšè— */
            transition: transform 0.1s, border-color 0.1s;
        }

        /* å·çœ‹æ¨¡å¼ (Ghost Text) */
        .word-grid.peeking .char-slot:not(.correct) {
            color: rgba(255, 255, 255, 0.25);
        }

        /* çŠ¶æ€ */
        .char-slot.active { border-bottom-color: var(--blue); transform: translateY(-4px); }
        .char-slot.correct { color: var(--text); border-bottom-color: transparent; }
        
        /* é”™è¯¯é—ªç° (çº¢è‰²) */
        .char-slot.flash-err {
            color: var(--red) !important;
            border-bottom-color: var(--red);
            animation: shake 0.2s;
        }

        .hint-text {
            margin-top: 40px; font-size: 0.8rem; color: #444;
        }

        /* --- 3. éšå½¢äº¤äº’å±‚ --- */
        .touch-layer {
            position: absolute; inset: 0; z-index: 5;
        }
        
        /* å½»åº•ç§»é™¤è¾“å…¥æ¡†çš„æ‰€æœ‰è‡ªåŠ¨åŠŸèƒ½ */
        #hidden-input {
            position: absolute; opacity: 0; top: 0; left: 0; height: 0; width: 0;
            pointer-events: none;
        }

        /* å¯åŠ¨é®ç½© */
        .splash {
            position: fixed; inset: 0; background: #000; z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.4s;
        }
        .start-btn {
            margin-top: 30px; padding: 14px 40px;
            background: var(--blue); border-radius: 40px;
            font-weight: 700; font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(10, 132, 255, 0.3);
            animation: pulse 2s infinite;
        }

        @keyframes shake { 0%,100% {transform:translateX(0)} 25% {transform:translateX(-4px)} 75% {transform:translateX(4px)} }
        @keyframes pulse { 50% { transform: scale(1.05); } }

    </style>
</head>
<body>

    <div class="header">
        <div class="top-row">
            <div class="title-group">
                IELTS Ultimate
                <div class="audio-dot" id="audio-dot"></div>
            </div>
            <div class="clock" id="clock">12:00</div>
        </div>
        
        <div class="ctrl-row">
            <select class="mode-select" id="mode-select" onchange="resetGame()">
                <option value="mix">ğŸ¯ Mix (P1+P4)</option>
                <option value="p1">ğŸ  P1 Survival</option>
                <option value="p4">ğŸ“ P4 Academic</option>
            </select>
            <div class="stats">
                <span>Done <span class="stat-val" id="count">0</span></span>
                <span>WPM <span class="stat-val" id="wpm">0</span></span>
                <span>Left <span class="stat-val" id="left">0</span></span>
            </div>
        </div>
    </div>

    <div class="stage">
        <div class="meaning" id="meaning">...</div>
        
        <div class="word-grid" id="word-grid"
             ontouchstart="startPeek(event)" 
             ontouchend="endPeek(event)"
             onmousedown="startPeek(event)" 
             onmouseup="endPeek(event)">
        </div>
        
        <div class="hint-text">Hold word to peek â€¢ Tap screen to type</div>
    </div>

    <div class="touch-layer" onclick="focusInput()"></div>
    
    <input type="text" id="hidden-input" 
           autocomplete="off" autocorrect="off" 
           autocapitalize="off" spellcheck="false">

    <div class="splash" id="splash" onclick="initApp()">
        <h1 style="font-size: 2.2rem;">IELTS Trainer</h1>
        <div style="color:#666; margin-top:5px">Full Feature Edition</div>
        <div class="start-btn">Tap to Start</div>
    </div>

<script>
    // ==========================================
    // ğŸ¯ æ ¸å¿ƒè¯åº“ (P1 + P4)
    // ==========================================
    const DATA_P1 = "accommodation:ä½å®¿|deposit:æŠ¼é‡‘|landlord:æˆ¿ä¸œ|balcony:é˜³å°|garage:è½¦åº“|studio:å•é—´|suburb:éƒŠåŒº|cupboard:æ©±æŸœ|itinerary:è¡Œç¨‹|souvenir:çºªå¿µå“|museum:åšç‰©é¦†|hostel:æ—…ç¤¾|pharmacy:è¯æˆ¿|surgeon:å¤–ç§‘åŒ»ç”Ÿ|vaccine:ç–«è‹—|nutrition:è¥å…»|resume:ç®€å†|salary:è–ªæ°´|helmet:å¤´ç›”|luggage:è¡Œæ";
    const DATA_P4 = "environment:ç¯å¢ƒ|pollution:æ±¡æŸ“|erosion:ä¾µèš€|drought:å¹²æ—±|avalanche:é›ªå´©|volcano:ç«å±±|hurricane:é£“é£|atmosphere:å¤§æ°”|predator:æ•é£Ÿè€…|extinction:ç­ç»|species:ç‰©ç§|bacteria:ç»†èŒ|virus:ç—…æ¯’|agriculture:å†œä¸š|irrigation:çŒæº‰|archaeology:è€ƒå¤|psychology:å¿ƒç†|geography:åœ°ç†|biology:ç”Ÿç‰©|chemistry:åŒ–å­¦|architecture:å»ºç­‘|hypothesis:å‡è®¾|plagiarism:æŠ„è¢­|dissertation:è®ºæ–‡";

    // å¼•æ“å˜é‡
    let deck = [], remainingDeck = [];
    let currentWord = {};
    let charIndex = 0;
    
    // ç»Ÿè®¡
    let startTime = null;
    let totalInputs = 0, correctInputs = 0, correctWords = 0;
    
    // Audio Context (é›¶å»¶è¿ŸéŸ³æ•ˆ)
    let actx = null;
    let realAudio = new Audio();
    
    // DOM
    const elInput = document.getElementById('hidden-input');
    const elGrid = document.getElementById('word-grid');
    const elMeaning = document.getElementById('meaning');
    const elDot = document.getElementById('audio-dot');
    const elSplash = document.getElementById('splash');
    const elClock = document.getElementById('clock');

    function initApp() {
        // 1. åˆå§‹åŒ–éŸ³é¢‘å¼•æ“
        actx = new (window.AudioContext || window.webkitAudioContext)();
        if(actx.state === 'suspended') actx.resume();

        // 2. éšè—å¯åŠ¨é¡µ
        elSplash.style.opacity = '0';
        setTimeout(() => elSplash.style.display = 'none', 400);

        // 3. å¯åŠ¨æ—¶é’Ÿ
        updateTime();
        setInterval(updateTime, 1000);

        // 4. ç»‘å®šè¾“å…¥ (æé€Ÿæ¨¡å¼)
        elInput.addEventListener('input', handleInputFast);
        elInput.addEventListener('keydown', e => {
            if(e.key === 'Enter') { e.preventDefault(); playRealAudio(); }
        });

        // 5. è‡ªåŠ¨èšç„¦å¾ªç¯ (é˜²æ­¢ç„¦ç‚¹ä¸¢å¤±)
        focusInput();
        
        resetGame();
    }

    // --- â° 1. æ—¶é’ŸåŠŸèƒ½ ---
    function updateTime() {
        const now = new Date();
        // ç¾å¼æ—¶é—´æ ¼å¼ 12:30 PM (ç¬¦åˆ iOS ä¹ æƒ¯)
        const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        elClock.textContent = `${timeStr}`; // ç®€æ´æ¨¡å¼ï¼Œåªæ˜¾ç¤ºæ—¶é—´ï¼Œé¿å…æŒ¤å ç©ºé—´
    }

    // --- ğŸ® 2. æ¸¸æˆé€»è¾‘ ---
    function resetGame() {
        const mode = document.getElementById('mode-select').value;
        let p1 = parseData(DATA_P1);
        let p4 = parseData(DATA_P4);
        
        if (mode === 'p1') deck = p1;
        else if (mode === 'p4') deck = p4;
        else deck = [...p1, ...p4];

        remainingDeck = [...deck].sort(() => Math.random() - 0.5);
        
        correctWords = 0; totalInputs = 0; correctInputs = 0; startTime = null;
        updateStats();
        loadNextWord();
    }

    async function loadNextWord() {
        if(remainingDeck.length === 0) remainingDeck = [...deck].sort(() => Math.random() - 0.5);
        currentWord = remainingDeck.pop();
        charIndex = 0;

        // UI æ¸²æŸ“
        elMeaning.textContent = currentWord.m;
        elMeaning.classList.add('visible');
        
        elGrid.innerHTML = '';
        currentWord.w.split('').forEach((char, i) => {
            const div = document.createElement('div');
            div.className = 'char-slot';
            div.textContent = char;
            if(i === 0) div.classList.add('active');
            elGrid.appendChild(div);
        });

        updateStats();
        
        // é¢„åŠ è½½éŸ³é¢‘
        elDot.classList.remove('ready');
        await fetchAudio(currentWord.w);
        playRealAudio();
    }

    // --- âš¡ï¸ 3. æé€Ÿè¾“å…¥å¤„ç† (é˜²æ­¢ç²˜è¿) ---
    function handleInputFast(e) {
        let char = '';
        if (e.data) char = e.data.slice(-1).toLowerCase();
        else if (elInput.value) char = elInput.value.slice(-1).toLowerCase();
        
        // å…³é”®ï¼šç«‹å³æ¸…ç©ºï¼Œé˜²æ­¢iOSé¢„æµ‹ç¼“å†²åŒºå †ç§¯
        elInput.value = '';

        if (!char) return;
        if (!startTime) startTime = Date.now();
        totalInputs++;

        const target = currentWord.w[charIndex].toLowerCase();
        const slots = elGrid.children;
        const currentSlot = slots[charIndex];

        if (char === target) {
            // âœ… æ­£ç¡®ï¼šæœºæ¢°å£° + éœ‡åŠ¨
            playTone(600, 'triangle', 0.05); // å“’å£°
            triggerHaptic();
            
            correctInputs++;
            currentSlot.classList.remove('active');
            currentSlot.classList.add('correct');
            charIndex++;

            if (charIndex >= currentWord.w.length) {
                correctWords++;
                playTone(800, 'sine', 0.1); // å®ŒæˆéŸ³
                setTimeout(loadNextWord, 150);
            } else {
                slots[charIndex].classList.add('active');
            }
        } else {
            // âŒ é”™è¯¯ï¼šé”¯é½¿æ³¢ + çº¢è‰²é—ªç°
            playTone(150, 'sawtooth', 0.1);
            triggerHaptic();
            
            currentSlot.classList.add('flash-err');
            setTimeout(() => currentSlot.classList.remove('flash-err'), 250);
        }
        updateStats();
    }

    // --- ğŸ‘† 4. é•¿æŒ‰å·çœ‹ (é€»è¾‘ä¼˜åŒ–) ---
    function startPeek(e) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘èƒŒæ™¯çš„ focusInput
        if(e) e.stopPropagation(); 
        // è§†è§‰åé¦ˆ
        elGrid.classList.add('peeking');
    }

    function endPeek(e) {
        if(e) e.stopPropagation();
        elGrid.classList.remove('peeking');
        // å·çœ‹ç»“æŸä¸ºäº†æ–¹ä¾¿ç»§ç»­æ‰“å­—ï¼Œé‡æ–°èšç„¦
        focusInput();
    }

    // --- ğŸ”Š 5. é›¶å»¶è¿ŸéŸ³æ•ˆç³»ç»Ÿ ---
    function playTone(freq, type, duration) {
        if(!actx) return;
        const osc = actx.createOscillator();
        const g = actx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, actx.currentTime);
        g.gain.setValueAtTime(0.15, actx.currentTime); // éŸ³é‡
        g.gain.exponentialRampToValueAtTime(0.01, actx.currentTime + duration);
        osc.connect(g); g.connect(actx.destination);
        osc.start(); osc.stop(actx.currentTime + duration);
    }

    // --- ğŸ“³ 6. è§¦æ„Ÿ ---
    function triggerHaptic() {
        if (navigator.vibrate) navigator.vibrate(15);
    }

    // --- ğŸ§ 7. çœŸäººå‘éŸ³ ---
    async function fetchAudio(word) {
        try {
            const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
            const data = await res.json();
            const audioObj = data[0]?.phonetics.find(p => p.audio && p.audio.includes('-us.mp3')) 
                          || data[0]?.phonetics.find(p => p.audio);
            if(audioObj) {
                realAudio.src = audioObj.audio;
                realAudio.load();
                elDot.classList.add('ready');
            }
        } catch(e) {}
    }
    
    function playRealAudio() {
        if (elDot.classList.contains('ready')) {
            realAudio.currentTime = 0;
            realAudio.play().catch(()=>{});
        } else {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(currentWord.w);
            u.lang = 'en-US'; u.rate = 0.9;
            window.speechSynthesis.speak(u);
        }
    }

    // --- è¾…åŠ© ---
    function focusInput() { elInput.focus(); }
    function parseData(str) { return str.split('|').map(s => { const [w, m] = s.split(':'); return { w, m }; }); }
    function updateStats() {
        document.getElementById('count').textContent = correctWords;
        document.getElementById('left').textContent = remainingDeck.length;
        if(startTime) {
            const m = (Date.now()-startTime)/60000;
            if(m>0) document.getElementById('wpm').textContent = Math.round((correctInputs/5)/m);
        }
    }
</script>
</body>
</html>